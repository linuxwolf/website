version: "3"

includes:
  docker:
    taskfile: ./.builder/docker/taskfile.yaml
    internal: true

vars:
  DOCKER_CONTEXT: '{{ default "default" .DOCKER_CONTEXT }}'

  DEFAULT_EPOCH: '{{ now | unixEpoch }}'
  DEFAULT_DATE: '{{ now | date "2006-01-02T15:04:05" }}'

tasks:
  build:
    vars:
      SOURCE_DATE: '{{ coalesce .SOURCE_DATE .DEFAULT_DATE }}'
    sources:
      - src/**
      - _config.ts
      - deno.json
      - deno.lock
    generates:
      - _site/**
    cmds:
      - deno task build
      - find _site | xargs -I{} touch -c -d {{ .SOURCE_DATE }} {}

  image:
    vars:
      SOURCE_EPOCH: '{{ coalesce .SOURCE_EPOCH .DEFAULT_EPOCH }}'
    deps:
      - build
    cmds:
      - task: docker:image
        vars:
          IMAGE_REPOSITORY: o-p-n/website
          DOCKER_SOURCE_EPOCH: '{{ .SOURCE_EPOCH }}'

  deploy.only:
    env:
      DOCKER_REGISTRY: "{{ .DOCKER_REGISTRY }}"
      IMAGE_TAG: "{{ .IMAGE_TAG }}"
    cmds:
      - cmd: |
          docker --context {{ .DOCKER_CONTEXT }} \
            stack deploy \
            --compose-file docker-compose.yaml \
            --prune \
            website

  deploy:
    cmds:
      - task: image
      - task: deploy.only